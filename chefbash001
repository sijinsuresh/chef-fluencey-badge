bash 'get_volume_id' do
  code <<-EOH
    az="us-west-2a"
    volume_id=$(aws ec2 describe-volumes --filters "Name=availability-zone,Values=$az" --query "Volumes[0].VolumeId" --output text)
    echo "Volume ID: $volume_id"
    echo "Setting volume_id node attribute"
    echo "node.default['volume_id'] = '$volume_id'" >> /tmp/attributes.rb
  EOH
  not_if { ::File.exist?('/tmp/attributes.rb') }
  notifies :run, 'ruby_block[load_attributes]', :immediately
end

ruby_block 'load_attributes' do
  block do
    include_recipe '/tmp/attributes.rb'
  end
  action :nothing
end
